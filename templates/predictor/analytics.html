{% extends 'base.html' %}

{% block title %}Analytics - Express Entry Analytics{% endblock %}

{% block content %}
<!-- Header -->
<section class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-chart-bar me-3"></i>
                    Express Entry Analytics
                </h1>
                <p class="lead mb-0">
                    Comprehensive analytics and insights from historical draw data
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Key Metrics -->
<section class="container mb-5">
    <div class="row" id="keyMetrics">
        <!-- Metrics will be loaded here -->
    </div>
</section>

<!-- Charts Section -->
<section class="container mb-5">
    <div class="row">
        <!-- CRS Trends Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        CRS Score Trends Over Time
                    </h5>
                </div>
                <div class="card-body">
                    <div id="crsChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Category Distribution -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-pie-chart me-2"></i>
                        Category Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="categoryChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Monthly Trends -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar me-2"></i>
                        Monthly Draw Count
                    </h5>
                </div>
                <div class="card-body">
                    <div id="monthlyChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Score vs Invitations -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-scatter-chart me-2"></i>
                        CRS Score vs Invitations
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scatterChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Recent Activity -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Recent Draw Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recentDrawsTable">
                            <thead class="table-primary">
                                <tr>
                                    <th>Round</th>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>CRS Score</th>
                                    <th>Invitations</th>
                                    <th>Days Since Last</th>
                                </tr>
                            </thead>
                            <tbody id="recentDrawsBody">
                                <!-- Recent draws will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Category Breakdown -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-list-alt me-2 text-primary"></i>
                Category Breakdown
            </h3>
        </div>
    </div>
    
    <div class="row" id="categoryBreakdown">
        <!-- Category cards will be loaded here -->
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
});

async function loadAnalyticsData() {
    try {
        const response = await axios.get('/api/stats/');
        const data = response.data;
        
        displayKeyMetrics(data);
        displayRecentDraws(data.recent_draws);
        // Remove category_breakdown since it's not available in our API
        displayNextPredictions(data.next_predictions);
        
        // Load charts with actual data
        loadCharts(data);
        
    } catch (error) {
        console.error('Error loading analytics data:', error);
        // Show error message to user
        const container = document.getElementById('keyMetrics');
        if (container) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading analytics data: ${error.message}
                    </div>
                </div>
            `;
        }
    }
}

function displayKeyMetrics(data) {
    const container = document.getElementById('keyMetrics');
    
    const metrics = [
        {
            title: 'Total Draws',
            value: data.total_draws.toLocaleString(),
            icon: 'fas fa-chart-line',
            color: 'primary',
            change: '+5 this month'
        },
        {
            title: 'Active Categories',
            value: data.categories_count.toString(),
            icon: 'fas fa-tags',
            color: 'success',
            change: 'All active'
        },
        {
            title: 'Average CRS Score',
            value: Math.round(data.avg_crs_score).toString(),
            icon: 'fas fa-trophy',
            color: 'warning',
            change: data.avg_crs_score > 500 ? 'Above 500' : 'Below 500'
        },
        {
            title: 'Average Invitations',
            value: Math.round(data.avg_invitations).toLocaleString(),
            icon: 'fas fa-users',
            color: 'info',
            change: 'Per draw'
        },
        {
            title: 'Date Range',
            value: `${formatDate(data.date_range.start)} - ${formatDate(data.date_range.end)}`,
            icon: 'fas fa-calendar-alt',
            color: 'secondary',
            change: 'Historical data'
        }
    ];
    
    container.innerHTML = '';
    
    metrics.forEach(metric => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 col-xl mb-3';
        
        col.innerHTML = `
            <div class="stats-card text-center text-white">
                <i class="${metric.icon} fa-2x mb-3"></i>
                <h4 class="mb-1">${metric.value}</h4>
                <p class="mb-1 fw-bold">${metric.title}</p>
                <small class="opacity-75">${metric.change}</small>
            </div>
        `;
        
        container.appendChild(col);
    });
}

function displayRecentDraws(draws) {
    const tbody = document.getElementById('recentDrawsBody');
    tbody.innerHTML = '';
    
    draws.forEach(draw => {
        const row = document.createElement('tr');
        const categoryClass = getCategoryClass(draw.category_name);
        
        row.innerHTML = `
            <td><strong>#${draw.round_number}</strong></td>
            <td>${formatDate(draw.date)}</td>
            <td><span class="badge ${categoryClass}">${draw.category_name}</span></td>
            <td><strong>${draw.lowest_crs_score}</strong></td>
            <td>${draw.invitations_issued.toLocaleString()}</td>
            <td>${draw.days_since_last_draw || 'N/A'} days</td>
        `;
        tbody.appendChild(row);
    });
}

function displayCategoryBreakdown(breakdown) {
    const container = document.getElementById('categoryBreakdown');
    container.innerHTML = '';
    
    breakdown.forEach(category => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-4';
        
        col.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="card-title mb-0">${category.category}</h6>
                        <span class="badge bg-primary">${category.count} draws</span>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <strong class="d-block">${Math.round(category.avg_crs)}</strong>
                                <small class="text-muted">Avg CRS</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <strong class="d-block">${formatDate(category.latest_draw)}</strong>
                            <small class="text-muted">Latest Draw</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
}

async function loadCharts(data) {
    try {
        // Simple chart with available data
        if (data.recent_draws && data.recent_draws.length > 0) {
            const crsData = {
                data: [{
                    x: data.recent_draws.map(draw => draw.date),
                    y: data.recent_draws.map(draw => draw.lowest_crs_score),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'CRS Score',
                    line: { color: '#007bff' }
                }],
                layout: {
                    title: 'Recent CRS Score Trends',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'CRS Score' },
                    hovermode: 'x unified'
                }
            };
            Plotly.newPlot('crsChart', crsData.data, crsData.layout);
        }
        
        // Category distribution based on recent draws
        if (data.recent_draws && data.recent_draws.length > 0) {
            const categoryCount = {};
            data.recent_draws.forEach(draw => {
                categoryCount[draw.category_name] = (categoryCount[draw.category_name] || 0) + 1;
            });
            
            const categoryData = {
                data: [{
                    labels: Object.keys(categoryCount),
                    values: Object.values(categoryCount),
                    type: 'pie',
                    hole: 0.4
                }],
                layout: {
                    title: 'Category Distribution (Recent Draws)',
                    showlegend: true
                }
            };
            Plotly.newPlot('categoryChart', categoryData.data, categoryData.layout);
        }
        
        // Monthly draw count chart
        if (data.recent_draws && data.recent_draws.length > 0) {
            const monthlyCount = {};
            data.recent_draws.forEach(draw => {
                const date = new Date(draw.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyCount[monthKey] = (monthlyCount[monthKey] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyCount).sort();
            const monthlyData = {
                data: [{
                    x: sortedMonths,
                    y: sortedMonths.map(month => monthlyCount[month]),
                    type: 'bar',
                    name: 'Draw Count',
                    marker: { color: '#28a745' }
                }],
                layout: {
                    title: 'Monthly Draw Count',
                    xaxis: { title: 'Month' },
                    yaxis: { title: 'Number of Draws' },
                    showlegend: false
                }
            };
            Plotly.newPlot('monthlyChart', monthlyData.data, monthlyData.layout);
        }
        
        // CRS Score vs Invitations scatter plot
        if (data.recent_draws && data.recent_draws.length > 0) {
            const scatterData = {
                data: [{
                    x: data.recent_draws.map(draw => draw.lowest_crs_score),
                    y: data.recent_draws.map(draw => draw.invitations_issued),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Draws',
                    text: data.recent_draws.map(draw => `${draw.category_name}<br>Date: ${draw.date}`),
                    marker: {
                        size: 8,
                        color: data.recent_draws.map((_, i) => getCategoryColor(data.recent_draws[i].category_name)),
                        opacity: 0.8
                    }
                }],
                layout: {
                    title: 'CRS Score vs Invitations',
                    xaxis: { title: 'CRS Score' },
                    yaxis: { title: 'Invitations Issued' },
                    hovermode: 'closest',
                    showlegend: false
                }
            };
            Plotly.newPlot('scatterChart', scatterData.data, scatterData.layout);
        }
        
    } catch (error) {
        console.error('Error loading charts:', error);
    }
}

function displayNextPredictions(predictions) {
    const container = document.getElementById('nextPredictions');
    if (!container || !predictions || predictions.length === 0) return;
    
    container.innerHTML = predictions.slice(0, 5).map(pred => `
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">${pred.category}</h6>
                    <p class="card-text">
                        <strong>Date:</strong> ${formatDate(pred.predicted_date)}<br>
                        <strong>CRS:</strong> ${formatCRSWithCI(pred.predicted_crs_score, pred.uncertainty_range)}<br>
                        <strong>Confidence:</strong> ${pred.confidence_score}%
                    </p>
                </div>
            </div>
        </div>
    `).join('');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function getCategoryClass(categoryName) {
    const categoryClasses = {
        'Provincial Nominee Program': 'bg-primary',
        'Canadian Experience Class': 'bg-success',
        'Federal Skilled Worker': 'bg-info',
        'General': 'bg-secondary',
        'No Program Specified': 'bg-secondary',
        'French language proficiency': 'bg-warning',
        'Healthcare': 'bg-danger',
        'STEM': 'bg-dark'
    };
    
    for (const [key, className] of Object.entries(categoryClasses)) {
        if (categoryName.includes(key)) {
            return className;
        }
    }
    
    return 'bg-light text-dark';
}

// Format CRS score with 95% confidence interval
function formatCRSWithCI(score, uncertaintyRange) {
    if (uncertaintyRange && uncertaintyRange.min !== undefined && uncertaintyRange.max !== undefined) {
        return `${score} (${uncertaintyRange.min}–${uncertaintyRange.max})`;
    }
    return score.toString();
}

function getCategoryColor(categoryName) {
    const categoryColors = {
        'Provincial Nominee Program': '#007bff', // Blue
        'Canadian Experience Class': '#28a745', // Green
        'Federal Skilled Worker': '#17a2b8', // Teal
        'General': '#6c757d', // Gray
        'No Program Specified': '#6c757d', // Gray
        'French language proficiency': '#ffc107', // Yellow
        'Healthcare': '#dc3545', // Red
        'STEM': '#343a40' // Dark
    };
    return categoryColors[categoryName] || '#6c757d'; // Default to gray
}
</script>
{% endblock %} 