{% extends 'base.html' %}

{% block title %}Analytics - Express Entry Analytics{% endblock %}

{% block content %}
<!-- Header -->
<section class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-chart-bar me-3"></i>
                    Express Entry Analytics
                </h1>
                <p class="lead mb-0">
                    Advanced analytics with economic indicators, political context, and pool composition data for comprehensive Express Entry insights
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Key Metrics -->
<section class="container mb-5">
    <div class="row" id="keyMetrics">
        <!-- Metrics will be loaded here -->
    </div>
</section>

<!-- Charts Section -->
<section class="container mb-5">
    <!-- CRS Trends Chart - Full Width -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        CRS Score Trends Over Time - All Categories
                    </h5>
                </div>
                <div class="card-body">
                    <div id="crsChart" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Second Row Charts -->
    <div class="row">
        <!-- Category Distribution -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-pie-chart me-2"></i>
                        Category Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="categoryChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Monthly Draw Trends Section -->
<section class="container mb-5">
    <div class="row">
        <!-- Monthly Trends -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar me-2"></i>
                        Monthly Draw Count
                    </h5>
                </div>
                <div class="card-body">
                    <div id="monthlyChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CRS Score Analysis Section -->
<section class="container mb-5">
    <div class="row">
        <!-- Score vs Invitations -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-scatter-chart me-2"></i>
                        CRS Score vs Invitations
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scatterChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Recent Activity -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Recent Draw Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recentDrawsTable">
                            <thead class="table-primary">
                                <tr>
                                    <th>Round</th>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>CRS Score</th>
                                    <th>Invitations</th>
                                    <th>Days Since Last</th>
                                </tr>
                            </thead>
                            <tbody id="recentDrawsBody">
                                <!-- Recent draws will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Category Breakdown -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-list-alt me-2 text-primary"></i>
                Category Breakdown
            </h3>
        </div>
    </div>
    
    <div class="row" id="categoryBreakdown">
        <!-- Category cards will be loaded here -->
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
});

async function loadAnalyticsData() {
    try {
        const response = await axios.get('/api/stats/');
        const data = response.data;
        
        displayKeyMetrics(data);
        displayRecentDraws(data.recent_draws);
        // Remove category_breakdown since it's not available in our API
        displayNextPredictions(data.next_predictions);
        
        // Load charts with actual data
        loadCharts(data);
        
    } catch (error) {
        console.error('Error loading analytics data:', error);
        // Show error message to user
        const container = document.getElementById('keyMetrics');
        if (container) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading analytics data: ${error.message}
                    </div>
                </div>
            `;
        }
    }
}

function displayKeyMetrics(data) {
    const container = document.getElementById('keyMetrics');
    
    const metrics = [
        {
            title: 'Total Draws',
            value: data.total_draws.toLocaleString(),
            icon: 'fas fa-chart-line',
            color: 'primary',
            change: '+5 this month'
        },
        {
            title: 'Active Categories',
            value: data.categories_count.toString(),
            icon: 'fas fa-tags',
            color: 'success',
            change: 'All active'
        },
        {
            title: 'Average CRS Score',
            value: Math.round(data.avg_crs_score).toString(),
            icon: 'fas fa-trophy',
            color: 'warning',
            change: data.avg_crs_score > 500 ? 'Above 500' : 'Below 500'
        },
        {
            title: 'Average Invitations',
            value: Math.round(data.avg_invitations).toLocaleString(),
            icon: 'fas fa-users',
            color: 'info',
            change: 'Per draw'
        },
        {
            title: 'Date Range',
            value: `${formatDate(data.date_range.start)} - ${formatDate(data.date_range.end)}`,
            icon: 'fas fa-calendar-alt',
            color: 'secondary',
            change: 'Historical data'
        }
    ];
    
    container.innerHTML = '';
    
    metrics.forEach(metric => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 col-xl mb-3';
        
        col.innerHTML = `
            <div class="stats-card text-center text-white">
                <i class="${metric.icon} fa-2x mb-3"></i>
                <h4 class="mb-1">${metric.value}</h4>
                <p class="mb-1 fw-bold">${metric.title}</p>
                <small class="opacity-75">${metric.change}</small>
            </div>
        `;
        
        container.appendChild(col);
    });
}

function displayRecentDraws(draws) {
    const tbody = document.getElementById('recentDrawsBody');
    tbody.innerHTML = '';
    
    draws.forEach(draw => {
        const row = document.createElement('tr');
        const categoryClass = getCategoryClass(draw.category_name);
        
        const daysSince = calculateDaysSince(draw.date);
        
        row.innerHTML = `
            <td><strong>#${draw.round_number}</strong></td>
            <td>${formatDate(draw.date)}</td>
            <td><span class="badge ${categoryClass}">${draw.category_name}</span></td>
            <td><strong>${draw.lowest_crs_score}</strong></td>
            <td>${draw.invitations_issued.toLocaleString()}</td>
            <td>${daysSince === 'N/A' ? 'N/A' : daysSince} days</td>
        `;
        tbody.appendChild(row);
    });
}

function displayCategoryBreakdown(breakdown) {
    const container = document.getElementById('categoryBreakdown');
    container.innerHTML = '';
    
    breakdown.forEach(category => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-4';
        
        col.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="card-title mb-0">${category.category}</h6>
                        <span class="badge bg-primary">${category.count} draws</span>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <strong class="d-block">${Math.round(category.avg_crs)}</strong>
                                <small class="text-muted">Avg CRS</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <strong class="d-block">${formatDate(category.latest_draw)}</strong>
                            <small class="text-muted">Latest Draw</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
}

async function loadMonthlyDrawTrends() {
    try {
        // Get ALL historical draws data for complete timeline (2015-2025)
        const response = await axios.get('/api/draws/'); // No limit - get all historical data
        const drawsData = response.data.results || response.data;
        
        if (!drawsData || drawsData.length === 0) {
            console.warn('No draws data available for monthly trends');
            return;
        }
        
        // Group draws by month
        const monthlyCount = {};
        drawsData.forEach(draw => {
            const date = new Date(draw.date);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            monthlyCount[monthKey] = (monthlyCount[monthKey] || 0) + 1;
        });
        
        // Sort months chronologically
        const sortedMonths = Object.keys(monthlyCount).sort();
        
        // Format month labels for better readability
        const formattedMonths = sortedMonths.map(month => {
            const [year, monthNum] = month.split('-');
            const date = new Date(year, monthNum - 1);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        });
        
        const monthlyData = {
            data: [{
                x: formattedMonths,
                y: sortedMonths.map(month => monthlyCount[month]),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Monthly Draw Count',
                line: { 
                    color: '#28a745',
                    width: 3
                },
                marker: { 
                    size: 6,
                    color: '#28a745',
                    opacity: 0.8
                },
                hovertemplate: '<b>Monthly Draw Count</b><br>' +
                             'Month: %{x}<br>' +
                             'Draws: %{y}<br>' +
                             '<extra></extra>'
            }],
            layout: {
                title: {
                    text: 'Monthly Draw Count Trends (2015-2025)',
                    font: { size: 18 }
                },
                xaxis: { 
                    title: 'Month',
                    tickangle: -45
                },
                yaxis: { 
                    title: 'Number of Draws',
                    rangemode: 'tozero'
                },
                showlegend: false,
                hovermode: 'closest'
            }
        };
        
        Plotly.newPlot('monthlyChart', monthlyData.data, monthlyData.layout);
        
    } catch (error) {
        console.error('Error loading monthly draw trends:', error);
    }
}

async function loadCRSTrendsByCategory() {
    try {
        // Get ALL historical draws data for complete timeline
        const response = await axios.get('/api/draws/'); // No limit - get all historical data
        const drawsData = response.data.results || response.data;
        
        if (!drawsData || drawsData.length === 0) {
            console.warn('No draws data available for CRS trends');
            return;
        }
        
        // Group draws by category
        const categoriesData = {};
        drawsData.forEach(draw => {
            const categoryName = draw.category_name || 'Unknown';
            if (!categoriesData[categoryName]) {
                categoriesData[categoryName] = [];
            }
            categoriesData[categoryName].push({
                date: draw.date,
                crs_score: draw.lowest_crs_score,
                invitations: draw.invitations_issued,
                round: draw.round_number
            });
        });
        
        // Sort each category's data by date
        Object.keys(categoriesData).forEach(category => {
            categoriesData[category].sort((a, b) => new Date(a.date) - new Date(b.date));
        });
        
        // Create traces for each category with improved gap handling
        const traces = Object.keys(categoriesData).map((categoryName, index) => {
            const categoryDraws = categoriesData[categoryName];
            const color = getCategoryColor(categoryName);
            
            // Determine if this is an active or legacy category
            const latestDraw = new Date(Math.max(...categoryDraws.map(d => new Date(d.date))));
            const currentDate = new Date();
            const monthsOld = (currentDate - latestDraw) / (1000 * 60 * 60 * 24 * 30);
            const isLegacy = monthsOld > 12; // Consider legacy if no draws in 12+ months
            
            return {
                x: categoryDraws.map(draw => draw.date),
                y: categoryDraws.map(draw => draw.crs_score),
                type: 'scatter',
                mode: 'lines+markers',
                name: categoryName + (isLegacy ? ' (Legacy)' : ''),
                line: { 
                    color: color, 
                    width: isLegacy ? 2 : 3,
                    dash: isLegacy ? 'dot' : 'solid'
                },
                marker: { 
                    size: isLegacy ? 6 : 8,
                    color: color,
                    opacity: isLegacy ? 0.6 : 0.8,
                    symbol: isLegacy ? 'circle-open' : 'circle'
                },
                hovertemplate: '<b>%{fullData.name}</b><br>' +
                             'Date: %{x}<br>' +
                             'CRS Score: %{y}<br>' +
                             'Invitations: %{customdata}<br>' +
                             '<extra></extra>',
                customdata: categoryDraws.map(draw => draw.invitations?.toLocaleString() || 'N/A'),
                connectgaps: false, // Don't connect large gaps between data points
                visible: isLegacy ? 'legendonly' : true // Hide legacy categories by default
            };
        });
        
        // Calculate date range for better x-axis
        const allDates = Object.values(categoriesData).flat().map(d => new Date(d.date));
        const minDate = new Date(Math.min(...allDates));
        const maxDate = new Date(Math.max(...allDates));
        
        // Calculate dynamic CRS score range from actual data
        const allCRSScores = Object.values(categoriesData).flat()
            .map(d => d.crs_score)
            .filter(score => score && score > 0); // Filter out null/undefined/zero scores
        
        const minCRS = Math.min(...allCRSScores);
        const maxCRS = Math.max(...allCRSScores);
        
        // Add some padding to the range (5% on each side)
        const crsRange = maxCRS - minCRS;
        const padding = Math.max(crsRange * 0.05, 10); // Minimum 10 points padding
        const yAxisMin = Math.max(minCRS - padding, 0); // Don't go below 0
        const yAxisMax = maxCRS + padding;
        
        const layout = {
            title: {
                text: 'Historical CRS Score Trends by Category (2015-2025)',
                font: { size: 20 }
            },
            xaxis: { 
                title: 'Date',
                type: 'date',
                range: [minDate, maxDate],
                gridcolor: 'rgba(128,128,128,0.2)',
                tickformat: '%Y-%m'
            },
            yaxis: { 
                title: 'CRS Score',
                gridcolor: 'rgba(128,128,128,0.2)',
                range: [yAxisMin, yAxisMax] // Dynamic range based on actual data
            },
            hovermode: 'closest',
            showlegend: true,
            legend: {
                orientation: 'h',
                x: 0.5,
                xanchor: 'center',
                y: -0.15,
                yanchor: 'top',
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: 'rgba(0, 0, 0, 0.1)',
                borderwidth: 1
            },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            margin: {
                l: 60,
                r: 40,
                t: 80,
                b: 120
            },
            annotations: [{
                text: 'Tip: Legacy categories (dotted lines) are hidden by default. Click legend to show.',
                showarrow: false,
                xref: 'paper',
                yref: 'paper',
                x: 0.02,
                y: 1.02,
                xanchor: 'left',
                yanchor: 'bottom',
                font: { size: 12, color: 'gray' }
            }]
        };
        
        Plotly.newPlot('crsChart', traces, layout, {responsive: true, displayModeBar: false});
        
    } catch (error) {
        console.error('Error loading CRS trends by category:', error);
        
        // Fallback to simple chart
        document.getElementById('crsChart').innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Unable to load detailed CRS trends. Please try refreshing the page.
            </div>
        `;
    }
}

async function loadCharts(data) {
    try {
        // Load comprehensive CRS trends by category
        await loadCRSTrendsByCategory();
        
        // Keep existing recent draws simple visualization for other charts
        if (data.recent_draws && data.recent_draws.length > 0) {
            // Note: CRS chart is now handled by loadCRSTrendsByCategory()
        }
        
        // Category distribution based on recent draws
        if (data.recent_draws && data.recent_draws.length > 0) {
            const categoryCount = {};
            data.recent_draws.forEach(draw => {
                categoryCount[draw.category_name] = (categoryCount[draw.category_name] || 0) + 1;
            });
            
            const categoryData = {
                data: [{
                    labels: Object.keys(categoryCount),
                    values: Object.values(categoryCount),
                    type: 'pie',
                    hole: 0.4
                }],
                layout: {
                    title: 'Category Distribution (Recent Draws)',
                    showlegend: true
                }
            };
            Plotly.newPlot('categoryChart', categoryData.data, categoryData.layout);
        }
        
        // Monthly draw count chart using full historical data (2015-2025)
        await loadMonthlyDrawTrends();
        
        // CRS Score vs Invitations scatter plot
        if (data.recent_draws && data.recent_draws.length > 0) {
            const scatterData = {
                data: [{
                    x: data.recent_draws.map(draw => draw.lowest_crs_score),
                    y: data.recent_draws.map(draw => draw.invitations_issued),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Draws',
                    text: data.recent_draws.map(draw => `${draw.category_name}<br>Date: ${draw.date}`),
                    marker: {
                        size: 8,
                        color: data.recent_draws.map((_, i) => getCategoryColor(data.recent_draws[i].category_name)),
                        opacity: 0.8
                    }
                }],
                layout: {
                    title: 'CRS Score vs Invitations',
                    xaxis: { title: 'CRS Score' },
                    yaxis: { title: 'Invitations Issued' },
                    hovermode: 'closest',
                    showlegend: false
                }
            };
            Plotly.newPlot('scatterChart', scatterData.data, scatterData.layout);
        }
        
    } catch (error) {
        console.error('Error loading charts:', error);
    }
}

function displayNextPredictions(predictions) {
    const container = document.getElementById('nextPredictions');
    if (!container || !predictions || predictions.length === 0) return;
    
    container.innerHTML = predictions.slice(0, 5).map(pred => `
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">${pred.category}</h6>
                    <p class="card-text">
                        <strong>Date:</strong> ${formatDateWithCI(pred.predicted_date, pred.uncertainty_range)}<br>
                        <strong>CRS:</strong> ${formatCRSWithCI(pred.predicted_crs_score, pred.uncertainty_range)}<br>
                        <strong>Confidence:</strong> ${pred.confidence_score}%
                    </p>
                </div>
            </div>
        </div>
    `).join('');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function calculateDaysSince(dateString) {
    if (!dateString) return 'N/A';
    
    const drawDate = new Date(dateString);
    const today = new Date();
    
    // Calculate the difference in milliseconds
    const timeDifference = today.getTime() - drawDate.getTime();
    
    // Convert to days and round down
    const daysDifference = Math.floor(timeDifference / (1000 * 3600 * 24));
    
    return daysDifference;
}

function getCategoryClass(categoryName) {
    const categoryClasses = {
        'Provincial Nominee Program': 'bg-primary',
        'Canadian Experience Class': 'bg-success',
        'Federal Skilled Worker': 'bg-info',
        'General': 'bg-secondary',
        'No Program Specified': 'bg-secondary',
        'French language proficiency': 'bg-warning',
        'Healthcare': 'bg-danger',
        'STEM': 'bg-dark'
    };
    
    for (const [key, className] of Object.entries(categoryClasses)) {
        if (categoryName.includes(key)) {
            return className;
        }
    }
    
    return 'bg-light text-dark';
}

// Format CRS score with 95% confidence interval
    function formatCRSWithCI(score, uncertaintyRange) {
        // Handle both old format (min/max) and new format (crs_min/crs_max)
        const minScore = uncertaintyRange?.crs_min || uncertaintyRange?.min;
        const maxScore = uncertaintyRange?.crs_max || uncertaintyRange?.max;
        
        if (minScore !== undefined && maxScore !== undefined) {
            return `${score} (${minScore}–${maxScore})`;
        }
        return score.toString();
    }

    function formatDateWithCI(predictedDate, uncertaintyRange) {
        if (!predictedDate) return 'N/A';
        
        // Format the main predicted date
        const mainDate = new Date(predictedDate);
        const formattedMain = mainDate.toLocaleDateString('en-CA', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        // Check if we have date uncertainty range
        if (uncertaintyRange && uncertaintyRange.date_earliest && uncertaintyRange.date_latest) {
            const earliestDate = new Date(uncertaintyRange.date_earliest);
            const latestDate = new Date(uncertaintyRange.date_latest);
            
            // Format the range dates
            const formattedEarliest = earliestDate.toLocaleDateString('en-CA', {
                month: 'short',
                day: 'numeric'
            });
            const formattedLatest = latestDate.toLocaleDateString('en-CA', {
                month: 'short', 
                day: 'numeric'
            });
            
            return `${formattedMain} (${formattedEarliest}–${formattedLatest})`;
        }
        
        return formattedMain;
    }

function getCategoryColor(categoryName) {
    const categoryColors = {
        // Main Immigration Categories
        'Provincial Nominee Program': '#FF6B35',        // Vibrant Orange
        'Canadian Experience Class': '#00A8CC',         // Bright Cyan  
        'Federal Skilled Worker': '#7209B7',            // Rich Purple
        'Federal Skilled Trades': '#FF8C42',            // Distinct Orange-Red
        'General': '#2D3748',                           // Dark Blue-Gray
        'No Program Specified': '#8B5A3C',             // Brown
        
        // Language Categories
        'French language proficiency': '#E53E3E',       // Bright Red
        'Francophone minority communities': '#C05621',  // Darker Orange-Red
        
        // Occupation-Based Categories  
        'Healthcare occupations': '#38A169',            // Medical Green
        'Healthcare': '#22C55E',                        // Brighter Green (different from healthcare occupations)
        'STEM occupations': '#3182CE',                  // Tech Blue
        'STEM': '#1E40AF',                              // Deeper Blue
        'Agriculture and agri-food occupations': '#10B981', // Emerald Green
        'Education occupations': '#9F7AEA',            // Education Purple
        'Trade occupations': '#F59E0B',                // Amber
        'Transport occupations': '#06B6D4',            // Sky Blue
        
        // Additional Categories
        'International Student': '#EC4899',            // Pink
        'Essential Worker': '#84CC16',                  // Lime Green
        'Entrepreneur': '#F97316',                      // Orange
        'Caregiver': '#8B5CF6',                        // Violet
        'Rural and Northern': '#059669',               // Teal Green
        'Skilled Worker': '#DC2626',                   // Red
        'Business': '#7C3AED',                         // Purple
        'Investor': '#B91C1C',                         // Dark Red
        'Self-employed': '#065F46',                    // Dark Green
    };
    
    // If exact match found, return it
    if (categoryColors[categoryName]) {
        return categoryColors[categoryName];
    }
    
    // Try partial matches for flexibility
    for (const [key, color] of Object.entries(categoryColors)) {
        if (categoryName && categoryName.toLowerCase().includes(key.toLowerCase())) {
            return color;
        }
    }
    
    // Generate a consistent color based on category name hash for unknown categories
    if (categoryName) {
        const fallbackColors = [
            '#6366F1', '#8B5CF6', '#EC4899', '#EF4444', '#F97316', 
            '#F59E0B', '#84CC16', '#22C55E', '#10B981', '#14B8A6',
            '#06B6D4', '#3B82F6', '#6366F1', '#8B5CF6', '#D946EF'
        ];
        
        // Create a simple hash from the category name
        let hash = 0;
        for (let i = 0; i < categoryName.length; i++) {
            hash = ((hash << 5) - hash + categoryName.charCodeAt(i)) & 0xffffffff;
        }
        
        // Use hash to pick a consistent color
        const colorIndex = Math.abs(hash) % fallbackColors.length;
        return fallbackColors[colorIndex];
    }
    
    return '#6B7280'; // Neutral gray as final fallback
}
</script>
{% endblock %} 