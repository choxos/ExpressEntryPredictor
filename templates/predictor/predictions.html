{% extends 'base.html' %}

{% block title %}Express Entry Predictions - AI Forecasts{% endblock %}

{% block extra_css %}
<!-- Cache busting and refresh meta tags -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
.category-tab-content {
    min-height: 400px;
}

.prediction-card {
    transition: transform 0.2s ease-in-out;
}

.prediction-card:hover {
    transform: translateY(-3px);
}

.model-badge {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}

.confidence-bar {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    position: relative;
    overflow: hidden;
}

.confidence-indicator {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 4px;
}

.nav-tabs .nav-link {
    border-radius: 8px 8px 0 0;
    margin-right: 2px;
}

.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-color: #007bff;
}

.tab-pane {
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    background: white;
    padding: 1.5rem;
}

.prediction-timeline-item {
    border-left: 3px solid #007bff;
    padding-left: 1rem;
    margin-bottom: 1rem;
    position: relative;
}

.prediction-timeline-item::before {
    content: '';
    position: absolute;
    left: -6px;
    top: 8px;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: #007bff;
}

.uncertainty-range {
    font-size: 0.85rem;
    color: #6c757d;
}

.invitation-highlight {
    background: linear-gradient(135deg, #e8f5e8, #f0f9f0);
    border-left: 3px solid #28a745;
    padding: 0.5rem;
    border-radius: 0 6px 6px 0;
}

.crs-highlight {
    background: linear-gradient(135deg, #fff3cd, #fefefe);
    border-left: 3px solid #ffc107;
    padding: 0.5rem;
    border-radius: 0 6px 6px 0;
}
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-crystal-ball me-3"></i>
                    Express Entry Predictions by Category
                </h1>
                <p class="lead mb-0">
                    Enhanced AI forecasts using LSTM, SARIMA, Prophet, Gaussian Process, and advanced ensemble models with clean features and uncertainty quantification
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Control Section -->
<section class="container mb-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label for="timeframe" class="form-label">Prediction Timeframe:</label>
                            <select class="form-select" id="timeframe">
                                <option value="next_month">Next Month</option>
                                <option value="next_quarter">Next Quarter</option>
                                <option value="rest_of_year" selected>Rest of Year</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="refreshPredictions()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Predictions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Category Tabs -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <div class="loading-spinner" id="predictionsLoading" style="display: block;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading predictions...</span>
                </div>
                <p class="mt-2">Generating AI predictions...</p>
            </div>
            
            <div id="categoryTabsContainer" style="display: none;">
                <!-- Category Navigation Tabs -->
                <ul class="nav nav-tabs" id="categoryTabs" role="tablist">
                    <!-- Tabs will be dynamically generated -->
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="categoryTabContent">
                    <!-- Tab panes will be dynamically generated -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Selected Category Performance -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-cogs me-2 text-primary"></i>
                <span id="selectedCategoryTitle">Category Performance Overview</span>
            </h3>
        </div>
    </div>
    
    <div class="row" id="modelPerformance">
        <!-- Model performance cards will be inserted here -->
    </div>
</section>

<!-- Category Timeline Chart -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        <span id="chartTitle">Prediction Timeline</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="timelineChart" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let allPredictions = [];
let currentCategory = null;
let categories = [];

document.addEventListener('DOMContentLoaded', function() {
    loadPredictions();
    
    // Add event listener for timeframe filtering
    document.getElementById('timeframe').addEventListener('change', filterByTimeframe);
});

async function loadPredictions() {
    const loading = document.getElementById('predictionsLoading');
    const tabsContainer = document.getElementById('categoryTabsContainer');
    
    loading.style.display = 'block';
    tabsContainer.style.display = 'none';
    
    try {
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        const response = await axios.get(`/api/predict/?t=${timestamp}`);
        const apiData = response.data;
        
        if (apiData.success && apiData.data && Array.isArray(apiData.data)) {
            console.log('Raw API data:', apiData.data);
            
            // Transform API data to match expected structure
            allPredictions = apiData.data.map(categoryData => {
                // Ensure predictions array exists and has data
                const predictions = categoryData.predictions || [];
                
                return {
                    id: categoryData.category_id,
                    category_name: categoryData.category_name,
                    category: {
                        id: categoryData.category_id,
                        name: categoryData.category_name,
                        description: categoryData.category_description
                    },
                    predictions: predictions,
                    recent_draws: categoryData.recent_draws || [],
                    last_updated: categoryData.last_updated
                };
            });
            
            console.log('Transformed predictions:', allPredictions);
            
            loading.style.display = 'none';
            tabsContainer.style.display = 'block';
            
            createCategoryTabs();
            
        } else {
            throw new Error('No prediction data available');
        }
        
    } catch (error) {
        loading.style.display = 'none';
        console.error('Error loading predictions:', error);
        
        document.getElementById('categoryTabsContainer').innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading predictions: ${error.message}. 
                <br><br>
                <strong>Try these steps:</strong>
                <ol class="text-start mt-2 small">
                    <li>Press <kbd>Ctrl+F5</kbd> (or <kbd>Cmd+Shift+R</kbd> on Mac) to hard refresh</li>
                    <li>Clear your browser cache and reload</li>
                    <li>Check the browser console (F12) for detailed error messages</li>
                </ol>
            </div>
        `;
    }
}

function createCategoryTabs() {
    const tabsNav = document.getElementById('categoryTabs');
    const tabsContent = document.getElementById('categoryTabContent');
    
    tabsNav.innerHTML = '';
    tabsContent.innerHTML = '';
    
    // Filter out categories with no predictions
    const validCategories = allPredictions.filter(cat => cat.predictions && cat.predictions.length > 0);
    
    if (validCategories.length === 0) {
        tabsContent.innerHTML = `
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle me-2"></i>
                No predictions available. Try refreshing or check back later.
            </div>
        `;
        return;
    }
    
    validCategories.forEach((categoryData, index) => {
        const categoryName = categoryData.category_name;
        const categoryId = `category-${categoryData.id}`;
        const isActive = index === 0;
        
        // Create tab navigation
        const tabNav = document.createElement('li');
        tabNav.className = 'nav-item';
        tabNav.innerHTML = `
            <button class="nav-link ${isActive ? 'active' : ''}" 
                    id="${categoryId}-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#${categoryId}" 
                    type="button" 
                    role="tab" 
                    aria-controls="${categoryId}" 
                    aria-selected="${isActive}">
                <i class="fas fa-folder me-2"></i>
                ${abbreviateCategoryName(categoryName)}
                <span class="badge bg-light text-dark ms-2">${categoryData.predictions.length}</span>
            </button>
        `;
        
        // Add click event to update performance and chart
        tabNav.querySelector('.nav-link').addEventListener('click', () => {
            currentCategory = categoryData;
            updateCategoryContent(categoryData);
        });
        
        tabsNav.appendChild(tabNav);
        
        // Create tab content
        const tabPane = document.createElement('div');
        tabPane.className = `tab-pane fade ${isActive ? 'show active' : ''}`;
        tabPane.id = categoryId;
        tabPane.setAttribute('role', 'tabpanel');
        tabPane.setAttribute('aria-labelledby', `${categoryId}-tab`);
        
        tabPane.innerHTML = createCategoryContent(categoryData);
        tabsContent.appendChild(tabPane);
        
        // Set initial category for performance display
        if (isActive) {
            currentCategory = categoryData;
            updateCategoryContent(categoryData);
        }
    });
}

function createCategoryContent(categoryData) {
    const categoryName = categoryData.category_name;
    const predictions = categoryData.predictions || [];
    const recentDraws = categoryData.recent_draws || [];
    
    if (predictions.length === 0) {
        return `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No predictions available for ${categoryName}
            </div>
        `;
    }
    
    // Group predictions by model for better organization
    const predictionsByModel = {};
    predictions.forEach(pred => {
        const modelName = pred.model_used || 'Unknown Model';
        if (!predictionsByModel[modelName]) {
            predictionsByModel[modelName] = [];
        }
        predictionsByModel[modelName].push(pred);
    });
    
    let content = `
        <div class="category-tab-content">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4 class="mb-3">${categoryName}</h4>
                    <p class="text-muted">${categoryData.category.description || 'AI-powered predictions for this Express Entry category'}</p>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">Category Statistics</h6>
                            <div class="row">
                                <div class="col-4">
                                    <strong>${predictions.length}</strong><br>
                                    <small class="text-muted">Total Predictions</small>
                                </div>
                                <div class="col-4">
                                    <strong>${Object.keys(predictionsByModel).length}</strong><br>
                                    <small class="text-muted">Models Used</small>
                                </div>
                                <div class="col-4">
                                    <strong>${calculateAverageInvitations(predictions)}</strong><br>
                                    <small class="text-muted">Avg. Invitations</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    `;
    
    // Recent draws section
    if (recentDraws.length > 0) {
        content += `
            <div class="row mb-4">
                <div class="col-12">
                    <h5><i class="fas fa-history me-2"></i>Recent Draws</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>CRS Score</th>
                                    <th>Invitations</th>
                                    <th>Round #</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentDraws.slice(0, 5).map(draw => `
                                    <tr>
                                        <td>${draw.date ? formatDate(draw.date) : 'N/A'}</td>
                                        <td><strong>${draw.lowest_crs_score || 'N/A'}</strong></td>
                                        <td>${draw.invitations_issued ? draw.invitations_issued.toLocaleString() : 'N/A'}</td>
                                        <td>#${draw.round_number || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Group predictions by date to show all models per date
    const predictionsByDate = {};
    predictions.forEach(pred => {
        const dateKey = pred.predicted_date ? pred.predicted_date.split('T')[0] : 'unknown';
        if (!predictionsByDate[dateKey]) {
            predictionsByDate[dateKey] = [];
        }
        predictionsByDate[dateKey].push(pred);
    });
    
    // Sort dates chronologically
    const sortedDates = Object.keys(predictionsByDate).sort((a, b) => {
        if (a === 'unknown') return 1;
        if (b === 'unknown') return -1;
        return new Date(a) - new Date(b);
    });
    
    content += `
        <div class="row mb-4">
            <div class="col-12">
                <h5><i class="fas fa-crystal-ball me-2"></i>All Predictions by Date (${predictions.length} total from ${sortedDates.length} time periods)</h5>
                <p class="text-muted mb-3">Each card shows predictions from ALL AI models for the same time period</p>
            </div>
        </div>
        <div class="row">
    `;
    
    sortedDates.forEach((dateKey, dateIndex) => {
        const datePredictions = predictionsByDate[dateKey];
        const displayDate = dateKey !== 'unknown' ? formatDate(dateKey) : 'Unknown Date';
        
        // Calculate average metrics across all models for this date
        const avgCRS = datePredictions.reduce((sum, p) => sum + (p.predicted_crs_score || 0), 0) / datePredictions.length;
        const avgInvitations = datePredictions.reduce((sum, p) => sum + (p.predicted_invitations || 0), 0) / datePredictions.length;
        const avgConfidence = datePredictions.reduce((sum, p) => sum + (p.confidence_score || 0), 0) / datePredictions.length;
        
        content += `
            <div class="col-lg-6 mb-4">
                <div class="card prediction-card h-100 shadow-sm">
                    <div class="card-header ${getCategoryClass(categoryName)} text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar me-2"></i>
                                    ${displayDate}
                                </h6>
                                <small class="opacity-75">${datePredictions.length} Models Predicting</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-white text-dark fs-6">
                                    ${Math.round(avgConfidence)}%
                                </span>
                                <div class="small opacity-75">Avg. Confidence</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Date summary -->
                        <div class="row mb-4 text-center bg-light rounded-3 p-3 mx-1">
                            <div class="col-4">
                                <div class="p-2">
                                    <h5 class="mb-1 text-warning fw-bold">${Math.round(avgCRS)}</h5>
                                    <small class="text-muted">Avg. CRS Score</small>
                                </div>
                            </div>
                            <div class="col-4 border-start border-end">
                                <div class="p-2">
                                    <h5 class="mb-1 text-success fw-bold">${Math.round(avgInvitations).toLocaleString()}</h5>
                                    <small class="text-muted">Avg. Invitations</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2">
                                    <h5 class="mb-1 text-primary fw-bold">${datePredictions.length}</h5>
                                    <small class="text-muted">AI Models</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- All model predictions for this date -->
                        <h6 class="mb-3"><i class="fas fa-brain me-2"></i>Predictions by Model:</h6>
                        <div class="model-predictions">
                            ${datePredictions.map((pred, modelIndex) => {
                                const modelColor = getModelColor(pred.model_used || 'Unknown');
                                const confidence = pred.confidence_score || 0;
                                
                                return `
                                    <div class="model-prediction-item mb-3 p-3 border-0 rounded shadow-sm" style="background: linear-gradient(135deg, ${modelColor}15 0%, ${modelColor}05 100%); border-left: 4px solid ${modelColor} !important;">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h6 class="mb-1" style="color: ${modelColor};">
                                                    <i class="fas fa-brain me-2"></i>
                                                    ${pred.model_used || 'Unknown Model'}
                                                </h6>
                                                <small class="text-muted">AI Model Prediction</small>
                                            </div>
                                            <span class="badge rounded-pill" style="background-color: ${modelColor}; color: white; font-size: 0.75rem;">
                                                ${Math.round(confidence)}% Confidence
                                            </span>
                                        </div>
                                        
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="text-center p-2 bg-white rounded">
                                                    <div class="crs-highlight">
                                                        <i class="fas fa-trophy text-warning mb-1"></i>
                                                        <div class="fw-bold text-dark fs-5">
                                                            ${pred.predicted_crs_score ? formatCRSWithCI(pred.predicted_crs_score, pred.uncertainty_range) : 'N/A'}
                                                        </div>
                                                        <div class="small text-muted">CRS Score</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-center p-2 bg-white rounded">
                                                    <div class="invitation-highlight">
                                                        <i class="fas fa-users text-success mb-1"></i>
                                                        <div class="fw-bold text-dark fs-5">
                                                            ${pred.predicted_invitations ? formatInvitationsWithCI(pred.predicted_invitations, pred.uncertainty_range) : 'N/A'}
                                                        </div>
                                                        <div class="small text-muted">Invitations</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Confidence bar for this model -->
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">Model Confidence</small>
                                                <small class="fw-bold" style="color: ${modelColor};">${confidence}%</small>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar" role="progressbar" style="width: ${confidence}%; background-color: ${modelColor};" aria-valuenow="${confidence}" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                        
                                        ${pred.uncertainty_range && pred.uncertainty_range.invitations_confidence ? `
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">
                                                    Invitations Confidence: <strong>${pred.uncertainty_range.invitations_confidence}%</strong>
                                                </small>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    content += `</div></div>`;
    
    return content;
}

function updateCategoryContent(categoryData) {
    const categoryName = categoryData.category_name;
    
    // Update titles
    document.getElementById('selectedCategoryTitle').textContent = `${categoryName} Performance`;
    document.getElementById('chartTitle').textContent = `${categoryName} Prediction Timeline`;
    
    // Update performance and chart for this category only
    displayModelPerformance([categoryData]);
    createTimelineChart([categoryData]);
}

function displayModelPerformance(categoryPredictions) {
    const container = document.getElementById('modelPerformance');
    container.innerHTML = '';
    
    if (!categoryPredictions || categoryPredictions.length === 0) return;
    
    const categoryData = categoryPredictions[0];
    const predictions = categoryData.predictions || [];
    
    // Calculate metrics for this category
    const avgConfidence = predictions.length > 0 ? 
        predictions.reduce((sum, p) => sum + (p.confidence_score || 0), 0) / predictions.length : 0;
    
    const modelTypes = new Set(predictions.map(p => p.model_used || 'Unknown'));
    const nextPrediction = predictions[0];
    
    const avgInvitations = calculateAverageInvitations(predictions);
    
    const lastUpdate = categoryData.last_updated ? 
        new Date(categoryData.last_updated).toLocaleDateString() : 'Unknown';
    
    const metrics = [
        {
            title: 'Average Confidence',
            value: `${Math.round(avgConfidence)}%`,
            icon: 'fas fa-thumbs-up',
            color: avgConfidence >= 70 ? 'success' : avgConfidence >= 50 ? 'warning' : 'danger'
        },
        {
            title: 'Avg. Invitations',
            value: avgInvitations,
            icon: 'fas fa-users',
            color: 'success'
        },
        {
            title: 'Active Models',
            value: `${modelTypes.size} Models`,
            icon: 'fas fa-cogs',
            color: 'info'
        },
        {
            title: 'Next CRS Score',
            value: nextPrediction ? nextPrediction.predicted_crs_score : 'N/A',
            icon: 'fas fa-trophy',
            color: 'warning'
        }
    ];
    
    metrics.forEach(metric => {
        const col = document.createElement('div');
        col.className = 'col-md-3 mb-3';
        
        col.innerHTML = `
            <div class="card text-center">
                <div class="card-body">
                    <i class="${metric.icon} fa-2x text-${metric.color} mb-3"></i>
                    <h4 class="mb-1">${metric.value}</h4>
                    <p class="mb-0 text-muted">${metric.title}</p>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
}

function createTimelineChart(categoryPredictions) {
    if (!categoryPredictions || categoryPredictions.length === 0) {
        document.getElementById('timelineChart').innerHTML = '<p class="text-center text-muted">No data available for chart</p>';
        return;
    }
    
    const chartData = [];
    const categoryData = categoryPredictions[0];
    const predictions = categoryData.predictions || [];
    
    // Group predictions by model
    const modelGroups = {};
    predictions.forEach(pred => {
        const modelName = pred.model_used || 'Unknown';
        if (!modelGroups[modelName]) {
            modelGroups[modelName] = [];
        }
        modelGroups[modelName].push({
                                        x: pred.predicted_date || new Date(),
                            y: pred.predicted_crs_score || 0,
                            confidence: pred.confidence_score || 75,
                            invitations: pred.predicted_invitations || 0
        });
    });
    
    const traces = Object.keys(modelGroups).map(modelName => {
        const points = modelGroups[modelName].sort((a, b) => new Date(a.x) - new Date(b.x));
        
        return {
            x: points.map(p => p.x),
            y: points.map(p => p.y),
            mode: 'lines+markers',
            name: modelName,
            line: {
                width: 3
            },
            marker: {
                size: 8,
                opacity: 0.8
            },
            hovertemplate: '<b>%{fullData.name}</b><br>' +
                          'Date: %{x}<br>' +
                          'Predicted CRS: %{y}<br>' +
                          'Invitations: %{customdata.invitations}<br>' +
                          'Confidence: %{customdata.confidence}%<br>' +
                          '<extra></extra>',
            customdata: points.map(p => ({
                confidence: Math.round(p.confidence || 0),
                invitations: p.invitations && !isNaN(p.invitations) ? parseInt(p.invitations).toLocaleString() : 'N/A'
            }))
        };
    });
    
    const layout = {
        title: {
            text: `${categoryData.category_name} - CRS Predictions by Model`,
            font: { size: 16 },
            y: 0.95
        },
        xaxis: {
            title: 'Date',
            type: 'date'
        },
        yaxis: {
            title: 'CRS Score',
            range: [300, 900]
        },
        hovermode: 'closest',
        showlegend: true,
        legend: {
            orientation: 'h',
            x: 0.5,
            xanchor: 'center',
            y: -0.15,
            yanchor: 'top'
        },
        margin: {
            l: 60,
            r: 40,
            t: 80,
            b: 120
        },
        height: 450
    };
    
    Plotly.newPlot('timelineChart', traces, layout, {responsive: true});
}

function refreshPredictions() {
    loadPredictions();
}

function filterByTimeframe() {
    if (currentCategory) {
        updateCategoryContent(currentCategory);
    }
}

// Utility functions
function calculateAverageInvitations(predictions) {
    if (!predictions || predictions.length === 0) return 'N/A';
    
    const validInvitations = predictions
        .map(p => p.predicted_invitations)
        .filter(inv => inv !== null && inv !== undefined && !isNaN(inv));
    
    if (validInvitations.length === 0) return 'N/A';
    
    const average = validInvitations.reduce((sum, inv) => sum + inv, 0) / validInvitations.length;
    
    if (isNaN(average)) return 'N/A';
    
    return Math.round(average).toLocaleString();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatCRSWithCI(score, uncertaintyRange) {
    const minScore = uncertaintyRange?.crs_min || uncertaintyRange?.min;
    const maxScore = uncertaintyRange?.crs_max || uncertaintyRange?.max;
    
    if (minScore !== undefined && maxScore !== undefined) {
        return `${score} (${minScore}–${maxScore})`;
    }
    return score.toString();
}

function formatInvitationsWithCI(invitations, uncertaintyRange) {
    if (!invitations && invitations !== 0) return 'N/A';
    
    // Ensure invitations is a valid number before formatting
    const invitationsNum = parseInt(invitations);
    if (isNaN(invitationsNum)) return 'N/A';
    
    const formattedInvitations = invitationsNum.toLocaleString();
    
    // Check for invitation-specific confidence intervals
    const minInvitations = uncertaintyRange?.invitations_min || uncertaintyRange?.min_invitations;
    const maxInvitations = uncertaintyRange?.invitations_max || uncertaintyRange?.max_invitations;
    
    if (minInvitations !== undefined && maxInvitations !== undefined) {
        const minNum = parseInt(minInvitations);
        const maxNum = parseInt(maxInvitations);
        
        if (!isNaN(minNum) && !isNaN(maxNum)) {
            const formattedMin = minNum.toLocaleString();
            const formattedMax = maxNum.toLocaleString();
            return `${formattedInvitations} (${formattedMin}–${formattedMax})`;
        }
    }
    
    return formattedInvitations;
}

function formatDateWithCI(predictedDate, uncertaintyRange) {
    if (!predictedDate) return 'N/A';
    
    const mainDate = new Date(predictedDate);
    const formattedMain = mainDate.toLocaleDateString('en-CA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
    
    if (uncertaintyRange && uncertaintyRange.date_earliest && uncertaintyRange.date_latest) {
        const earliestDate = new Date(uncertaintyRange.date_earliest);
        const latestDate = new Date(uncertaintyRange.date_latest);
        
        const formattedEarliest = earliestDate.toLocaleDateString('en-CA', {
            month: 'short',
            day: 'numeric'
        });
        const formattedLatest = latestDate.toLocaleDateString('en-CA', {
            month: 'short', 
            day: 'numeric'
        });
        
        return `${formattedMain} (${formattedEarliest}–${formattedLatest})`;
    }
    
    return formattedMain;
}

function getModelColor(modelName) {
    const colors = {
        'Gaussian Process': '#198754',
        'Bayesian Hierarchical': '#0dcaf0',
        'SARIMA': '#ffc107',
        'LSTM': '#6f42c1',
        'Prophet': '#fd7e14',
        'ARIMA': '#dc3545',
        'Holt-Winters': '#20c997',
        'VAR': '#6c757d',
        'Clean Linear Regression': '#0d6efd',
        'Advanced Ensemble': '#495057'
    };
    
    return colors[modelName] || '#0d6efd';
}

function getCategoryClass(categoryName) {
    const categoryClasses = {
        'Provincial Nominee Program': 'bg-primary',
        'Canadian Experience Class': 'bg-success',
        'Federal Skilled Worker': 'bg-info',
        'General': 'bg-secondary',
        'No Program Specified': 'bg-secondary',
        'French language proficiency': 'bg-warning',
        'Healthcare': 'bg-danger',
        'STEM': 'bg-dark'
    };
    
    for (const [key, className] of Object.entries(categoryClasses)) {
        if (categoryName.includes(key)) {
            return className;
        }
    }
    
    return 'bg-light text-dark';
}

function abbreviateCategoryName(categoryName) {
    const abbreviations = {
        'Canadian Experience Class': 'CEC',
        'Provincial Nominee Program': 'PNP',
        'Federal Skilled Worker': 'FSW',
        'Federal Skilled Trades': 'FST',
        'Agriculture and agri-food occupations': 'Agriculture',
        'Healthcare and social services occupations': 'Healthcare',
        'Education occupations': 'Education',
        'French language proficiency': 'French',
        'STEM occupations': 'STEM',
        'Trade occupations': 'Trades',
        'Transport occupations': 'Transport',
        'General': 'General'
    };
    
    // Check for exact matches first
    for (const [key, abbrev] of Object.entries(abbreviations)) {
        if (categoryName.includes(key)) {
            return abbrev;
        }
    }
    
    // Default: use first word if no match found
    const firstWord = categoryName.split(' ')[0];
    return firstWord.length > 12 ? firstWord.substring(0, 12) + '...' : firstWord;
}
</script>
{% endblock %} 