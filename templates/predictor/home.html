{% extends 'base.html' %}

{% block title %}Express Entry Predictor - AI-Powered Draw Predictions{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-4">
                    ðŸ‡¨ðŸ‡¦ Predict Your Express Entry Success
                </h1>
                <p class="lead mb-4">
                    Get AI-powered predictions for Canadian Express Entry draws. Our enhanced machine learning models analyze economic, political, and pool data with 87+ features to forecast draw dates, CRS scores, and invitation volumes, helping you achieve your Canadian immigration dream.
                </p>
                <div class="d-flex gap-3">
                    <a href="{% url 'predictor:predictions' %}" class="btn btn-light btn-lg">
                        <i class="fas fa-magic me-2"></i>View Predictions
                    </a>
                                    <a href="{% url 'predictor:analytics' %}" class="btn btn-outline-light btn-lg">
                    <i class="fas fa-chart-bar me-2"></i>Analytics
                    </a>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="text-center">
                    <i class="fas fa-brain" style="font-size: 8rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Quick Stats -->
<section class="container mb-5">
    <div class="row" id="quickStats">
        <div class="col-md-3 mb-3">
            <div class="stats-card text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h4 id="totalDraws">-</h4>
                <p class="mb-0">Total Draws</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h4 id="avgInvitations">-</h4>
                <p class="mb-0">Avg Invitations</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card text-center">
                <i class="fas fa-trophy fa-2x mb-2"></i>
                <h4 id="avgCRS">-</h4>
                <p class="mb-0">Avg CRS Score</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card text-center">
                <i class="fas fa-calendar fa-2x mb-2"></i>
                <h4 id="activeCategories">-</h4>
                <p class="mb-0">Active Categories</p>
            </div>
        </div>
    </div>
</section>

<!-- Latest Predictions -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-crystal-ball me-2 text-primary"></i>
                Latest Predictions
            </h2>
            <p class="text-center text-muted mb-5">
                AI-powered forecasts for upcoming Express Entry draws
            </p>
        </div>
    </div>
    
    <div class="row" id="predictionsContainer">
        <div class="col-12">
            <div class="loading-spinner" id="predictionsLoading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading predictions...</span>
                </div>
                <p class="mt-2">Generating predictions...</p>
            </div>
        </div>
    </div>
</section>

<!-- Best Predictions for All Categories -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-trophy me-2 text-warning"></i>
                Best Predictions for All Categories
            </h2>
            <p class="text-center text-muted mb-4">Next draw predictions for all active Express Entry categories</p>
        </div>
    </div>
    
    <div class="row" id="allPredictionsContainer">
        <div class="col-12">
            <div class="loading-spinner" id="allPredictionsLoading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading all predictions...</span>
                </div>
                <p class="mt-2">Loading predictions for all categories...</p>
            </div>
        </div>
    </div>
</section>

<!-- Recent Draws -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-history me-2 text-primary"></i>
                Recent Draws
            </h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recentDrawsTable">
                            <thead class="table-primary">
                                <tr>
                                    <th>Round</th>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>CRS Score</th>
                                    <th>Invitations</th>
                                </tr>
                            </thead>
                            <tbody id="recentDrawsBody">
                                <!-- Recent draws will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="container mb-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-5 canada-accent">Why Choose Our Predictor?</h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Enhanced AI Models âœ¨</h5>
                    <p class="card-text">
                        Advanced machine learning with XGBoost, LSTM, and specialized InvitationPredictor using 87+ features for superior accuracy.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fas fa-database fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Comprehensive Data ðŸš€</h5>
                    <p class="card-text">
                        Analyzes 350+ draws with economic indicators, political context, pool composition, and PNP activity for holistic predictions.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Scientific Precision ðŸ“Š</h5>
                    <p class="card-text">
                        95% confidence intervals, invitation volume prediction, and uncertainty quantification for reliable forecasts.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fas fa-calculator fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Personal Draw Calculator</h5>
                    <p class="card-text">
                        Calculate your estimated draw time based on your CRS score and eligible Express Entry categories.
                    </p>
                    <a href="{% url 'predictor:draw-calculator' %}" class="btn btn-primary btn-sm mt-2">
                        <i class="fas fa-calculator"></i> Calculate Now
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load analytics stats
    loadAnalyticsStats();
    
    // Load latest predictions
    loadLatestPredictions();
    
    // Load all predictions
    loadAllPredictions();
});

async function loadAnalyticsStats() {
    try {
        const response = await axios.get('/api/stats/');
        const data = response.data;
        
        // Update quick stats
        document.getElementById('totalDraws').textContent = data.total_draws.toLocaleString();
        document.getElementById('avgInvitations').textContent = Math.round(data.avg_invitations).toLocaleString();
        document.getElementById('avgCRS').textContent = Math.round(data.avg_crs_score);
        document.getElementById('activeCategories').textContent = data.categories_count;
        
        // Update recent draws table
        const tbody = document.getElementById('recentDrawsBody');
        tbody.innerHTML = '';
        
        data.recent_draws.forEach(draw => {
            const row = document.createElement('tr');
            const categoryClass = getCategoryClass(draw.category_name);
            
            row.innerHTML = `
                <td><strong>#${draw.round_number}</strong></td>
                <td>${formatDate(draw.date)}</td>
                <td><span class="badge ${categoryClass}">${draw.category_name}</span></td>
                <td><strong>${draw.lowest_crs_score}</strong></td>
                <td>${draw.invitations_issued.toLocaleString()}</td>
            `;
            tbody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error loading analytics stats:', error);
    }
}

async function loadLatestPredictions() {
    const container = document.getElementById('predictionsContainer');
    const loading = document.getElementById('predictionsLoading');
    
    loading.style.display = 'block';
    
    try {
        const response = await axios.get('/api/predict/');
        const apiData = response.data;
        
        loading.style.display = 'none';
        container.innerHTML = '';
        
        if (!apiData.success || !apiData.data || apiData.data.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No predictions available at the moment. Please check back later.
                    </div>
                </div>
            `;
            return;
        }
        
        apiData.data.slice(0, 3).forEach(categoryData => {
            const prediction = categoryData.predictions[0]; // Get first prediction
            const confidence = prediction.confidence_score;
            
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';
            
            col.innerHTML = `
                <div class="prediction-card h-100">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="mb-0">${categoryData.category_name}</h5>
                        <span class="confidence-badge bg-light text-dark">
                            ${confidence}% confidence
                        </span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Next Draw Date:</span>
                            <strong>${formatDate(prediction.predicted_date)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Predicted CRS:</span>
                            <strong id="crs-with-ci">${formatCRSWithCI(prediction.predicted_crs_score, prediction.uncertainty_range)}</strong>
                        </div>
                    </div>
                    
                    <div class="mt-auto">
                        <small class="opacity-75">
                            Model: ${prediction.model_used} | Rank: ${prediction.rank}
                        </small>
                    </div>
                </div>
            `;
            
            container.appendChild(col);
        });
        
        // Add "View All Predictions" card
        const viewAllCol = document.createElement('div');
        viewAllCol.className = 'col-12 text-center mt-3';
        viewAllCol.innerHTML = `
            <a href="/predictions/" class="btn btn-primary btn-lg">
                <i class="fas fa-eye me-2"></i>
                View All Predictions
            </a>
        `;
        container.appendChild(viewAllCol);
        
    } catch (error) {
        loading.style.display = 'none';
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading predictions. Please try again later.
                </div>
            </div>
        `;
        console.error('Error loading predictions:', error);
    }
}

async function loadAllPredictions() {
    const container = document.getElementById('allPredictionsContainer');
    const loading = document.getElementById('allPredictionsLoading');
    
    loading.style.display = 'block';
    
    try {
        const response = await axios.get('/api/predict/');
        const apiData = response.data;
        
        loading.style.display = 'none';
        container.innerHTML = '';
        
        if (!apiData.success || !apiData.data || apiData.data.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No predictions available at the moment. Please check back later.
                    </div>
                </div>
            `;
            return;
        }
        
        // Create a row for the cards
        const row = document.createElement('div');
        row.className = 'row';
        
        apiData.data.forEach(categoryData => {
            const prediction = categoryData.predictions[0]; // Get first prediction
            const confidence = prediction.confidence_score;
            
            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 mb-4';
            
            col.innerHTML = `
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title text-primary fw-bold mb-0">${categoryData.category_name}</h6>
                            <span class="badge bg-light text-dark">
                                ${confidence}% confidence
                            </span>
                        </div>
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted d-block">Next Draw</small>
                                    <strong>${formatDate(prediction.predicted_date)}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">CRS Score</small>
                                    <strong class="text-success">
                                        ${formatCRSWithCI(prediction.predicted_crs_score, prediction.uncertainty_range)}
                                    </strong>
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted d-block">Expected Invitations</small>
                            <strong>${prediction.predicted_invitations.toLocaleString()}</strong>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Model: ${prediction.model_used}</small>
                        </div>
                    </div>
                </div>
            `;
            
            row.appendChild(col);
        });
        
        container.appendChild(row);
        
    } catch (error) {
        loading.style.display = 'none';
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading all predictions. Please try again later.
                </div>
            </div>
        `;
        console.error('Error loading all predictions:', error);
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function getCategoryClass(categoryName) {
    const categoryClasses = {
        'Provincial Nominee Program': 'bg-primary',
        'Canadian Experience Class': 'bg-success',
        'Federal Skilled Worker': 'bg-info',
        'General': 'bg-secondary',
        'No Program Specified': 'bg-secondary',
        'French language proficiency': 'bg-warning',
        'Healthcare': 'bg-danger',
        'STEM': 'bg-dark'
    };
    
    for (const [key, className] of Object.entries(categoryClasses)) {
        if (categoryName.includes(key)) {
            return className;
        }
    }
    
    return 'bg-light text-dark';
}

// Format CRS score with 95% confidence interval
function formatCRSWithCI(score, uncertaintyRange) {
    // Handle both old format (min/max) and new format (crs_min/crs_max)
    const minScore = uncertaintyRange?.crs_min || uncertaintyRange?.min;
    const maxScore = uncertaintyRange?.crs_max || uncertaintyRange?.max;
    
    if (minScore !== undefined && maxScore !== undefined) {
        return `${score} (${minScore}â€“${maxScore})`;
    }
    return score.toString();
}

function formatDateWithCI(predictedDate, uncertaintyRange) {
    if (!predictedDate) return 'N/A';
    
    // Format the main predicted date
    const mainDate = new Date(predictedDate);
    const formattedMain = mainDate.toLocaleDateString('en-CA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
    
    // Check if we have date uncertainty range
    if (uncertaintyRange && uncertaintyRange.date_earliest && uncertaintyRange.date_latest) {
        const earliestDate = new Date(uncertaintyRange.date_earliest);
        const latestDate = new Date(uncertaintyRange.date_latest);
        
        // Format the range dates
        const formattedEarliest = earliestDate.toLocaleDateString('en-CA', {
            month: 'short',
            day: 'numeric'
        });
        const formattedLatest = latestDate.toLocaleDateString('en-CA', {
            month: 'short', 
            day: 'numeric'
        });
        
        return `${formattedMain} (${formattedEarliest}â€“${formattedLatest})`;
    }
    
    return formattedMain;
}
</script>
{% endblock %} 